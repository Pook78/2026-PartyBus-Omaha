<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luau Party Bus RSVP</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #ff4500;
      --accent: #00ced1;
      --bg: #fffaf0;
      --red: #d32f2f;
      --green: #2e7d32;
    }
    body {font-family: system-ui, sans-serif; max-width: 700px; margin: 0 auto; padding: 1rem; background:var(--bg);}
    h1 {text-align:center; color:var(--primary); margin-bottom:0.5rem;}
    .banner {background:linear-gradient(135deg,var(--primary),var(--accent)); color:white; padding:1.5rem; border-radius:12px; margin-bottom:1.5rem; text-align:center;}
    .banner h2 {margin:0.5rem 0; font-size:1.8rem;}
    .banner p {margin:0.4rem 0; font-size:1rem;}
    .theme {font-weight:bold; font-size:1.1rem; color:#fff;}
    .countdown {font-size:1.4rem; font-weight:bold; color:#fff; margin:0.8rem 0;}
    .spots {font-size:1.2rem; font-weight:bold; color:#fff; margin:0.5rem 0;}
    .form {margin:2rem 0; text-align:center;}
    input, select, button {font-size:1rem; padding:0.7rem; margin:0.4rem; border-radius:8px; width:100%; max-width:280px;}
    input, select {border:2px solid #ddd;}
    button {background:var(--primary); color:white; border:none; cursor:pointer; font-weight:bold;}
    button:hover {background:#e63900;}
    button:disabled {background:#ccc; cursor:not-allowed; opacity:0.7;}
    ul {list-style:none; padding:0;}
    li {padding:0.8rem; background:#fff; margin:0.5rem 0; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    .status {font-weight:bold; font-size:0.9rem; margin-left:0.5rem;}
    .pending {color:var(--red);}
    .paid {color:var(--green);}
    .total {font-weight:bold; margin:1.5rem 0; text-align:center; font-size:1.2rem; color:var(--primary);}
    .modal, .fullmodal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:99;}
    .modal-content, .fullmodal-content {background:white; padding:1.5rem; border-radius:12px; max-width:90%; text-align:center;}
    .close {float:right; font-size:1.5rem; cursor:pointer;}
    .info {background:#e6f7ff; padding:1rem; border-radius:8px; margin:1rem 0; font-size:0.95rem;}
    .note {font-size:0.85rem; color:#555; text-align:center; margin:1rem 0;}
  </style>
</head>
<body>
  <!-- BANNER -->
  <div class="banner">
    <h2>Luau Party Bus 2026!</h2>
    <p class="theme">Hawaiian gear required!</p>
    <p><strong>Date:</strong> <span id="eventDate"></span></p>
    <p><strong>Meet:</strong> <span id="meetTime"></span></p>
    <p><strong>Location:</strong> <span id="meetLocation"></span></p>
    <p><strong>Route:</strong> <span id="route"></span></p>
    <p><strong>Cost:</strong> $<span id="price"></span>/person</p>
    <p><strong>Refund:</strong> <span id="refund"></span></p>
    <p><strong>Pay:</strong> $<span id="price2"></span> to <a href="#" id="venmoLink" style="color:#fff; text-decoration:underline;" target="_blank">@YourVenmo</a></p>
    <div class="countdown" id="countdown">Loading...</div>
    <div class="spots" id="spotsLeft">Paid spots: 20</div>
  </div>

  <!-- INFO -->
  <div class="info">
    <strong>Meet at <span id="meetTime2"></span> sharp!</strong><br>
    White bus with neon. Leave at <span id="departTime"></span> — no late entry!<br>
    <em>Location: <span id="meetLocation2"></span></em>
  </div>

  <!-- FORM -->
  <div class="form">
    <input type="text" id="name" placeholder="Your name" required />
    <input type="email" id="email" placeholder="Email (reminders)" />
    <select id="guests" required>
      <option value="1" selected>1 person</option>
      <option value="2">2 people</option>
      <option value="3">3 people</option>
    </select>
    <button id="join">RSVP Now</button>
  </div>

  <div id="list"></div>
  <div class="total" id="total"></div>

  <p class="note">24h reminder. Text STOP to opt out.</p>

  <!-- PAYMENT MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" id="close">x</span>
      <h3>You're on the list!</h3>
      <p>Send <strong>$<span id="modalTotal">0</span></strong> to <a href="#" id="modalVenmo" target="_blank">@YourVenmo</a> to <strong>secure your spot</strong>.</p>
      <p><em>See you in Hawaiian gear!</em></p>
    </div>
  </div>

  <!-- BUS FULL WARNING -->
  <div class="fullmodal" id="fullModal">
    <div class="fullmodal-content">
      <span class="close" id="fullClose">x</span>
      <h3>Bus Full — Pay to Get On!</h3>
      <p><strong>20 people have paid.</strong> You can RSVP, but <strong>only paid guests board</strong>.</p>
      <p>Send $<span id="warnCost">0</span> to <a href="#" id="warnVenmo" target="_blank">@YourVenmo</a> to secure your spot.</p>
      <button onclick="allowRSVP()" style="background:#d32f2f; color:white; padding:0.7rem 1rem; border:none; border-radius:8px; cursor:pointer; margin-top:1rem;">I Understand — Let Me RSVP</button>
    </div>
  </div>

<script>
  // CONFIG
  const CONFIG = {
    maxPaid: 20,
    eventDate: 'February 28, 2026 18:00:00',
    meetTime: '6:00 PM',
    departTime: '6:15 PM',
    meetLocation: 'Parking Lot aaa behind Target, 72nd & Dodge, Omaha',
    route: 'Omaha → Wahoo → Ashland → Louisville → back',
    pricePerPerson: 50,
    venmoUsername: 'YourVenmo',
    venmoLink: 'https://venmo.com/your-venmo',
    refundPolicy: 'Full refund if canceled'
  };

  // FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyDXcsti1V6fNhlDTLEOjxA6cRi9StiW-tA",
    authDomain: "partybus-omaha.firebaseapp.com",
    databaseURL: "https://partybus-omaha-default-rtdb.firebaseio.com",
    projectId: "partybus-omaha",
    storageBucket: "partybus-omaha.firebasestorage.app",
    messagingSenderId: "463029096908",
    appId: "1:463029096908:web:e40a660ffae68ef34d0d69"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database().ref('rsvps');
  const viewsRef = firebase.database().ref('pageViews');

  // DOM
  const countdownEl = document.getElementById('countdown');
  const spotsEl = document.getElementById('spotsLeft');
  const modal = document.getElementById('modal');
  const fullModal = document.getElementById('fullModal');
  const close = document.getElementById('close');
  const fullClose = document.getElementById('fullClose');
  const nameInput = document.getElementById('name');
  const emailInput = document.getElementById('email');
  const guestsInput = document.getElementById('guests');
  const joinBtn = document.getElementById('join');
  const listEl = document.getElementById('list');
  const totalEl = document.getElementById('total');

  // Fill text
  document.getElementById('eventDate').textContent = new Date(CONFIG.eventDate).toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
  ['meetTime','meetTime2','meetTime3'].forEach(id => document.getElementById(id).textContent = CONFIG.meetTime);
  document.getElementById('departTime').textContent = CONFIG.departTime;
  ['meetLocation','meetLocation2'].forEach(id => document.getElementById(id).textContent = CONFIG.meetLocation);
  document.getElementById('route').textContent = CONFIG.route;
  ['price','price2'].forEach(id => document.getElementById(id).textContent = CONFIG.pricePerPerson);
  document.getElementById('refund').textContent = CONFIG.refundPolicy;
  ['venmoLink','modalVenmo','warnVenmo'].forEach(id => {
    const el = document.getElementById(id);
    el.href = CONFIG.venmoLink;
    el.textContent = '@' + CONFIG.venmoUsername;
  });

  // Close modals
  close.onclick = () => modal.style.display = 'none';
  fullClose.onclick = () => fullModal.style.display = 'none';
  window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; if (e.target === fullModal) fullModal.style.display = 'none'; };

  // Countdown
  function updateCountdown() {
    const diff = new Date(CONFIG.eventDate) - Date.now();
    if (diff <= 0) return countdownEl.textContent = "Luau time!";
    const d = Math.floor(diff / 86400000);
    const h = Math.floor((diff % 86400000) / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    countdownEl.innerHTML = `${d}d ${h}h ${m}m ${s}s`;
  }
  setInterval(updateCountdown, 1000); updateCountdown();

  // Allow RSVP after warning
  function allowRSVP() {
    fullModal.style.display = 'none';
    joinBtn.click();
  }

  // Submit RSVP
  joinBtn.onclick = () => {
    db.once('value').then(snap => {
      const data = snap.val() || {};
      const paidCount = Object.values(data).filter(v => v.paid).reduce((s,v) => s + v.guests, 0);

      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const guests = parseInt(guestsInput.value);
      if (!name) return alert('Enter name');

      const totalCost = guests * CONFIG.pricePerPerson;

      if (paidCount >= CONFIG.maxPaid) {
        document.getElementById('warnCost').textContent = totalCost;
        fullModal.style.display = 'flex';
        return;
      }

      db.push({ name, email, guests, paid: false, ts: Date.now() });
      nameInput.value = ''; emailInput.value = ''; guestsInput.value = 1;
      document.getElementById('modalTotal').textContent = totalCost;
      modal.style.display = 'flex';
    });
  };

  // Live update
  db.on('value', snap => {
    const data = snap.val() || {};
    const entries = Object.values(data).sort((a,b) => b.ts - a.ts);
    const totalPeople = entries.reduce((s,e) => s + e.guests, 0);
    const paidPeople = entries.filter(e => e.paid).reduce((s,e) => s + e.guests, 0);
    const spotsLeft = CONFIG.maxPaid - paidPeople;

    spotsEl.textContent = `Paid spots left: ${spotsLeft >= 0 ? spotsLeft : 0}`;
    if (spotsLeft <= 0) spotsEl.style.color = '#d00';

    listEl.innerHTML = '<ul>' + entries.map(e => {
      const status = e.paid ? `<span class="status paid">(paid)</span>` : `<span class="status pending">(pending)</span>`;
      return `<li><strong>${e.name}</strong> – ${e.guests} ${e.guests>1?'people':'person'} ${status}</li>`;
    }).join('') + '</ul>';

    totalEl.innerHTML = `Total: <strong>${totalPeople}</strong> RSVPs | <strong>${paidPeople}</strong> paid on bus`;
  });

  // === PAGE VIEW TRACKING ===
  (function() {
    if (sessionStorage.getItem('viewed')) return;
    sessionStorage.setItem('viewed', 'true');

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const device = isMobile ? 'iPhone/Android' : 'Desktop';
    const ip = 'unknown'; // Firebase can't get IP, but we log device

    fetch('https://api.ipify.org?format=json')
      .then(r => r.json())
      .catch(() => ({ ip: 'unknown' }))
      .then(data => {
        viewsRef.push({
          ts: Date.now(),
          device: device,
          ip: data.ip,
          page: 'index'
        });
      });
  })();
</script>
</body>
</html>
