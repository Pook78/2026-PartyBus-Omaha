<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Luau Bus Admin</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    * {box-sizing:border-box;}
    body {font-family:system-ui,sans-serif; max-width:700px; margin:2rem auto; padding:1rem; background:#f9f9f9; color:#222;}
    h1 {text-align:center; color:#d32f2f; margin-bottom:0.5rem;}
    .login {text-align:center; margin:2rem 0;}
    input {padding:0.7rem; font-size:1rem; width:200px; border:2px solid #ddd; border-radius:8px;}
    button {padding:0.7rem 1.2rem; font-size:1rem; border:none; border-radius:8px; cursor:pointer; margin:0.4rem;}
    .login button {background:#d32f2f; color:white;}
    .login button:hover {background:#b71c1c;}
    .hidden {display:none;}
    .stats {text-align:center; font-weight:bold; margin:1rem 0; font-size:1.1rem; background:#fff; padding:1rem; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);}
    .export {display:block; margin:1rem auto; background:#1976d2; color:white; padding:0.8rem 1.5rem;}
    .section {margin-top:2rem;}
    .section h2 {font-size:1.3rem; color:#d32f2f; border-bottom:2px solid #eee; padding-bottom:0.5rem;}
    ul {list-style:none; padding:0;}
    li {background:white; margin:0.5rem 0; padding:1rem; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:0.5rem;}
    .info strong {font-size:1.1rem;}
    .status {font-weight:bold; font-size:0.9rem;}
    .paid {color:#2e7d32;}
    .pending {color:#d32f2f;}
    .btn {padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer; font-size:0.9rem;}
    .mark {background:#4caf50; color:white;}
    .mark:disabled {background:#ccc; cursor:not-allowed;}
    .remove {background:#d32f2f; color:white;}
    .views {background:#e3f2fd; padding:1rem; border-radius:8px; margin:1rem 0;}
    .views h3 {margin:0.5rem 0; color:#1976d2;}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login" class="login">
    <h2>Admin Login</h2>
    <input type="password" id="pass" placeholder="Enter password" />
    <button onclick="login()">Enter</button>
    <p><small>Keep this page private!</small></p>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="admin" class="hidden">
    <h1>Luau Bus Admin</h1>
    
    <!-- STATS -->
    <div class="stats" id="stats">
      Loading...
    </div>

    <!-- EXPORT BUTTONS -->
    <button class="export" onclick="exportRSVP()">Download RSVPs CSV</button>
    <button class="export" onclick="exportViews()" style="background:#7b1fa2;">Download Views CSV</button>

    <!-- RSVPS -->
    <div class="section">
      <h2>RSVP List</h2>
      <ul id="rsvpList"></ul>
    </div>

    <!-- PAGE VIEWS -->
    <div class="section">
      <h2>Page Views</h2>
      <div class="views" id="viewsSummary">Loading...</div>
      <ul id="viewList"></ul>
    </div>
  </div>

<script>
  // === SETTINGS ===
  const PASSWORD = "bob1234";

  // === FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyDXcsti1V6fNhlDTLEOjxA6cRi9StiW-tA",
    authDomain: "partybus-omaha.firebaseapp.com",
    databaseURL: "https://partybus-omaha-default-rtdb.firebaseio.com",
    projectId: "partybus-omaha",
    storageBucket: "partybus-omaha.firebasestorage.app",
    messagingSenderId: "463029096908",
    appId: "1:463029096908:web:e40a660ffae68ef34d0d69"
  };
  firebase.initializeApp(firebaseConfig);
  const rsvpRef = firebase.database().ref('rsvps');
  const viewsRef = firebase.database().ref('pageViews');

  // === LOGIN ===
  function login() {
    if (document.getElementById('pass').value === PASSWORD) {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('admin').classList.remove('hidden');
      loadAll();
    } else {
      alert("Wrong password!");
    }
  }

  // === LOAD ALL DATA ===
  function loadAll() {
    loadRSVPs();
    loadViews();
  }

  // === LOAD RSVPS ===
  function loadRSVPs() {
    rsvpRef.on('value', snap => {
      const data = snap.val() || {};
      const entries = Object.entries(data).sort((a,b) => b[1].ts - a[1].ts);
      const totalSpots = entries.reduce((s,[k,v]) => s + v.guests, 0);
      const paidCount = entries.filter(([k,v]) => v.paid).length;
      const paidPeople = entries.filter(([k,v]) => v.paid).reduce((s,[k,v]) => s + v.guests, 0);

      document.getElementById('rsvpList').innerHTML = entries.map(([key, v]) => `
        <li>
          <div class="info">
            <strong>${v.name}</strong> – ${v.guests} ${v.guests>1?'people':'person'}
            <span class="status ${v.paid?'paid':'pending'}">(${v.paid?'paid':'pending'})</span>
            ${v.email ? `<br><small>${v.email}</small>` : ''}
          </div>
          <div>
            <button class="btn mark" ${v.paid?'disabled':''} onclick="markPaid('${key}', '${v.email||''}', '${v.name}')">
              ${v.paid?'Paid':'Mark Paid'}
            </button>
            <button class="btn remove" onclick="removeRSVP('${key}', '${v.name}')">Remove</button>
          </div>
        </li>
      `).join('');

      updateStats(entries.length, totalSpots, paidCount, paidPeople);
    });
  }

  // === LOAD PAGE VIEWS ===
  function loadViews() {
    viewsRef.on('value', snap => {
      const data = snap.val() || {};
      const views = Object.entries(data).sort((a,b) => b[1].ts - a[1].ts);
      const total = views.length;
      const mobile = views.filter(([k,v]) => v.device.includes('iPhone') || v.device.includes('Android')).length;
      const desktop = total - mobile;
      const uniqueIPs = new Set(views.map(([k,v]) => v.ip)).size;

      document.getElementById('viewsSummary').innerHTML = `
        <h3>Total Views: <strong>${total}</strong></h3>
        <p>Mobile: <strong>${mobile}</strong> | Desktop: <strong>${desktop}</strong> | Unique IPs: <strong>${uniqueIPs}</strong></p>
      `;

      document.getElementById('viewList').innerHTML = views.slice(0, 20).map(([k, v]) => `
        <li>
          <div><strong>${v.device}</strong> – ${v.ip}</div>
          <div><small>${new Date(v.ts).toLocaleString()}</small></div>
        </li>
      `).join('');
    });
  }

  // === UPDATE STATS BAR ===
  function updateStats(rsvpCount, totalSpots, paidCount, paidPeople) {
    const liveViews = document.querySelectorAll('#viewList li').length;
    document.getElementById('stats').innerHTML = `
      RSVPs: <strong>${rsvpCount}</strong> | 
      Spots Used: <strong>${totalSpots}</strong>/40 | 
      Paid: <strong>${paidCount}</strong> (${paidPeople} people) | 
      Live Views: <strong>${liveViews}</strong>
    `;
  }

  // === MARK PAID ===
  function markPaid(key, email, name) {
    if (confirm(`Mark ${name} as paid?`)) {
      rsvpRef.child(key).update({ paid: true });
    }
  }

  // === REMOVE RSVP ===
  function removeRSVP(key, name) {
    if (confirm(`Remove ${name}?`)) {
      rsvpRef.child(key).remove();
    }
  }

  // === EXPORT RSVPs CSV ===
  function exportRSVP() {
    rsvpRef.once('value').then(snap => {
      const data = snap.val() || {};
      const rows = [['Name','Guests','Email','Status','Added']];
      Object.values(data).forEach(v => {
        rows.push([v.name, v.guests, v.email||'', v.paid?'Paid':'Pending', new Date(v.ts).toLocaleString()]);
      });
      downloadCSV(rows, `luau-rsvps-${new Date().toISOString().slice(0,10)}.csv`);
    });
  }

  // === EXPORT VIEWS CSV ===
  function exportViews() {
    viewsRef.once('value').then(snap => {
      const data = snap.val() || {};
      const rows = [['Device','IP','Timestamp']];
      Object.values(data).forEach(v => {
        rows.push([v.device, v.ip, new Date(v.ts).toLocaleString()]);
      });
      downloadCSV(rows, `luau-views-${new Date().toISOString().slice(0,10)}.csv`);
    });
  }

  // === HELPER: DOWNLOAD CSV ===
  function downloadCSV(rows, filename) {
    const csv = rows.map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
